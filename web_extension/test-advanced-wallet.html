<!DOCTYPE html>
<html>
<head>
    <title>üöÄ Advanced Wallet Detection Test - TruthChain</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            max-width: 1000px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f8fafc;
        }
        .card { 
            background: white; 
            border-radius: 12px;
            padding: 20px; 
            margin: 15px 0; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .success { border-left: 4px solid #10b981; }
        .error { border-left: 4px solid #ef4444; }
        .warning { border-left: 4px solid #f59e0b; }
        .info { border-left: 4px solid #3b82f6; }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px;
            font-weight: 600;
        }
        button:hover { opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        pre {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
            line-height: 1.4;
        }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .status.detected { background: #dcfce7; color: #166534; }
        .status.not-detected { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>
    <div class="card">
        <h1>üöÄ TruthChain Advanced Wallet Detection Test</h1>
        <p>This page tests the new comprehensive wallet detection system with multiple fallback methods.</p>
        
        <div style="display: flex; align-items: center; gap: 10px;">
            <span>Advanced Detector Status:</span>
            <span id="detectorStatus" class="status not-detected">Initializing...</span>
        </div>
    </div>

    <div class="card">
        <h2>üéØ Test Suite</h2>
        <button onclick="testAdvancedDetection()">üîç Test Advanced Detection</button>
        <button onclick="testAdvancedConnection()">üîó Test Advanced Connection</button>
        <button onclick="testDebugAccess()">üõ†Ô∏è Test Debug Access</button>
        <button onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
    </div>

    <div id="results"></div>

    <div class="card info">
        <h3>üí° What this tests:</h3>
        <ul>
            <li><strong>50-attempt detection cycle</strong> - Aggressive polling every 500ms for 25 seconds</li>
            <li><strong>Multiple detection methods</strong> - Direct access, property enumeration, try-catch patterns</li>
            <li><strong>Event-driven detection</strong> - Listens for wallet-specific ready events</li>
            <li><strong>Debug access</strong> - Tests window.__truthchain_advanced_detector access</li>
            <li><strong>Connection flow</strong> - Full wallet connection with timeout handling</li>
        </ul>
    </div>

    <script>
        let logCount = 0;

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `card ${type}`;
            div.innerHTML = `
                <small style="color: #666;">[${new Date().toLocaleTimeString()}] #${++logCount}</small>
                <div>${message}</div>
            `;
            results.appendChild(div);
            console.log(`[Advanced Test] ${message}`);
            
            // Auto-scroll to bottom
            div.scrollIntoView({ behavior: 'smooth' });
        }

        function clearLogs() {
            document.getElementById('results').innerHTML = '';
            logCount = 0;
        }

        async function testAdvancedDetection() {
            log('<h3>üîç Testing Advanced Wallet Detection</h3>');
            
            try {
                const result = await new Promise((resolve, reject) => {
                    const requestId = `advanced_detect_${Date.now()}`;
                    
                    const responseHandler = (event) => {
                        if (event.data?.type === 'TRUTHCHAIN_ADVANCED_DETECT_RESULT' && 
                            event.data.requestId === requestId) {
                            window.removeEventListener('message', responseHandler);
                            
                            if (event.data.success) {
                                resolve(event.data.data);
                            } else {
                                reject(new Error(event.data.error));
                            }
                        }
                    };
                    
                    window.addEventListener('message', responseHandler);
                    
                    window.postMessage({
                        type: 'TRUTHCHAIN_ADVANCED_DETECT',
                        requestId: requestId
                    }, '*');
                    
                    setTimeout(() => {
                        window.removeEventListener('message', responseHandler);
                        reject(new Error('Advanced detection timeout'));
                    }, 5000);
                });
                
                log(`‚úÖ Advanced detection successful! Found ${result.length} wallets:`, 'success');
                log(`<pre>${JSON.stringify(result, null, 2)}</pre>`);
                
                // Update status
                const detected = result.some(w => w.detected);
                document.getElementById('detectorStatus').textContent = detected ? 'Active - Wallets Found' : 'Active - No Wallets';
                document.getElementById('detectorStatus').className = detected ? 'status detected' : 'status not-detected';
                
            } catch (error) {
                log(`‚ùå Advanced detection failed: ${error.message}`, 'error');
            }
        }

        async function testAdvancedConnection() {
            log('<h3>üîó Testing Advanced Wallet Connection</h3>');
            
            // First detect available wallets
            try {
                const detected = await new Promise((resolve, reject) => {
                    const requestId = `connect_detect_${Date.now()}`;
                    
                    const responseHandler = (event) => {
                        if (event.data?.type === 'TRUTHCHAIN_ADVANCED_DETECT_RESULT' && 
                            event.data.requestId === requestId) {
                            window.removeEventListener('message', responseHandler);
                            resolve(event.data.success ? event.data.data : []);
                        }
                    };
                    
                    window.addEventListener('message', responseHandler);
                    
                    window.postMessage({
                        type: 'TRUTHCHAIN_ADVANCED_DETECT',
                        requestId: requestId
                    }, '*');
                    
                    setTimeout(() => {
                        window.removeEventListener('message', responseHandler);
                        resolve([]);
                    }, 5000);
                });
                
                const availableWallets = detected.filter(w => w.detected);
                
                if (availableWallets.length === 0) {
                    log('‚ùå No wallets available for connection test', 'error');
                    return;
                }
                
                const wallet = availableWallets[0];
                log(`üîÑ Attempting advanced connection to ${wallet.name} (${wallet.provider})...`, 'info');
                
                const connectionResult = await new Promise((resolve, reject) => {
                    const requestId = `advanced_connect_${Date.now()}`;
                    
                    const responseHandler = (event) => {
                        if (event.data?.type === 'TRUTHCHAIN_ADVANCED_CONNECT_RESULT' && 
                            event.data.requestId === requestId) {
                            window.removeEventListener('message', responseHandler);
                            
                            if (event.data.success) {
                                resolve(event.data.data);
                            } else {
                                reject(new Error(event.data.error));
                            }
                        }
                    };
                    
                    window.addEventListener('message', responseHandler);
                    
                    window.postMessage({
                        type: 'TRUTHCHAIN_ADVANCED_CONNECT',
                        requestId: requestId,
                        provider: wallet.provider
                    }, '*');
                    
                    setTimeout(() => {
                        window.removeEventListener('message', responseHandler);
                        reject(new Error('Advanced connection timeout'));
                    }, 30000);
                });
                
                log(`üéâ Advanced connection successful!`, 'success');
                log(`<pre>${JSON.stringify(connectionResult, null, 2)}</pre>`);
                
            } catch (error) {
                log(`‚ùå Advanced connection failed: ${error.message}`, 'error');
            }
        }

        function testDebugAccess() {
            log('<h3>üõ†Ô∏è Testing Debug Access</h3>');
            
            try {
                const detector = window.__truthchain_advanced_detector;
                
                if (detector) {
                    log('‚úÖ Advanced detector accessible via window.__truthchain_advanced_detector', 'success');
                    
                    const detected = detector.getDetectedWallets();
                    log(`‚úÖ Direct method call successful: ${detected.length} wallets detected`, 'success');
                    log(`<pre>${JSON.stringify(detected, null, 2)}</pre>`);
                    
                    // Test detection count
                    const detectionAttempts = detector.detectionAttempts || 'N/A';
                    log(`‚ÑπÔ∏è Detection attempts so far: ${detectionAttempts}`, 'info');
                    
                } else {
                    log('‚ùå Advanced detector not accessible - page script may not be loaded', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Debug access failed: ${error.message}`, 'error');
            }
        }

        // Auto-start detection test when page loads
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('üöÄ Advanced Wallet Detection Test Started', 'info');
                testAdvancedDetection();
            }, 2000);
        });

        // Listen for detection updates
        window.addEventListener('message', (event) => {
            if (event.data?.type === 'TRUTHCHAIN_WALLET_DETECTION_UPDATE') {
                const providers = event.data.data?.providers || {};
                const detected = Object.entries(providers).filter(([k, v]) => v.isDetected);
                if (detected.length > 0) {
                    log(`üì° Automatic detection update: ${detected.length} wallet(s) - ${detected.map(([k]) => k).join(', ')}`, 'info');
                }
            }
        });
    </script>
</body>
</html>